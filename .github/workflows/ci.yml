name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]

env:
  COVERAGE_THRESHOLD: 25

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build binary
        run: go build -o agentspec ./cmd/agentspec

      - name: Run tests
        run: go test ./... -count=1 -v

      - name: Lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.10.1

      - name: Validate all examples
        run: |
          shopt -s nullglob
          files=(examples/*/*.ias)
          if [ ${#files[@]} -eq 0 ]; then
            echo "::warning::No example .ias files found matching examples/*/*.ias"
            exit 0
          fi
          for f in "${files[@]}"; do
            echo "Validating $f..."
            ./agentspec validate "$f"
          done

      - name: Format-check all examples
        run: |
          shopt -s nullglob
          files=(examples/*/*.ias)
          if [ ${#files[@]} -eq 0 ]; then
            echo "::warning::No example .ias files found matching examples/*/*.ias"
            exit 0
          fi
          for f in "${files[@]}"; do
            echo "Format-checking $f..."
            ./agentspec fmt --check "$f"
          done

      - name: Smoke test - plan
        run: |
          set +e
          ./agentspec plan examples/basic-agent/basic-agent.ias
          exit_code=$?
          set -e
          if [ $exit_code -eq 0 ] || [ $exit_code -eq 2 ]; then
            echo "Plan succeeded (exit $exit_code: changes pending or no changes)"
          else
            echo "::error::Plan failed with unexpected exit code $exit_code"
            exit $exit_code
          fi

      - name: Smoke test - apply
        run: ./agentspec apply examples/basic-agent/basic-agent.ias --auto-approve

      - name: Smoke test - idempotency check
        run: |
          output=$(./agentspec apply examples/basic-agent/basic-agent.ias --auto-approve 2>&1)
          echo "$output"
          if echo "$output" | grep -q "No changes"; then
            echo "Idempotency check passed: no changes on second apply"
          else
            echo "::error::Idempotency check failed: expected 'No changes' in output"
            exit 1
          fi

  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@v1.1.4

      - name: Run govulncheck
        run: govulncheck ./...

      - name: Run gosec via golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.10.1
          args: --enable gosec

  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests with coverage
        run: go test ./... -coverprofile=coverage.out -covermode=atomic -count=1

      - name: Display coverage report
        run: go tool cover -func=coverage.out

      - name: Check coverage threshold
        run: |
          total=$(go tool cover -func=coverage.out | grep '^total:' | awk '{print $NF}' | sed 's/%//')
          echo "Total coverage: ${total}%"
          echo "Threshold: ${COVERAGE_THRESHOLD}%"
          if [ "$(echo "$total < $COVERAGE_THRESHOLD" | bc -l)" -eq 1 ]; then
            echo "::error::Coverage ${total}% is below threshold ${COVERAGE_THRESHOLD}%"
            exit 1
          fi
          echo "Coverage check passed: ${total}% >= ${COVERAGE_THRESHOLD}%"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.out

  race-detection:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests with race detector
        run: go test ./... -race -count=1 -timeout=15m
